<head>
    <meta charset="utf-8" />
    <title>Pi-Hole Status</title>
    <link rel="stylesheet" href="sdpi.css">
</head>

<body>
<div class="sdpi-wrapper">
    <div class="sdpi-item">
        <label for="adminURL" class="sdpi-item-label">Admin URL</label>
        <input id="adminURL" class="sdpi-item-value" required="required" onchange="saveSettings()" />
    </div>
    <div class="sdpi-item">
        <label for="apiKey" class="sdpi-item-label">API Key</label>
        <input id="apiKey" class="sdpi-item-value" required="required" type="password" onchange="saveSettings()" />
    </div>
    <div class="sdpi-item">
        <label for="disableDurationSeconds" class="sdpi-item-label">Disable Duration</label>
        <input id="disableDurationSeconds" class="sdpi-item-value" type="number" placeholder="(seconds)" onchange="saveSettings()" />
    </div>
    <div class="sdpi-item">
        <label for="refreshIntervalSeconds" class="sdpi-item-label">Refresh Interval</label>
        <input id="refreshIntervalSeconds" class="sdpi-item-value" type="number" placeholder="(seconds)" onchange="saveSettings()" />
    </div>
</div>

<script>
    var websocket = null,
        uuid = null,
        actionInfo = {};

    function connectElgatoStreamDeckSocket(inPort, inUUID, inRegisterEvent, inInfo, inActionInfo) {
        uuid = inUUID;
        actionInfo = JSON.parse(inActionInfo); // cache the info
        websocket = new WebSocket('ws://127.0.0.1:' + inPort);

        websocket.onopen = function () {
            websocket.send(JSON.stringify({
                event: inRegisterEvent,
                uuid: inUUID
            }));
        }

        websocket.onmessage = function (event) {
            // Received message from Stream Deck
            const jsonObj = JSON.parse(event.data);

            if (jsonObj.event === "sendToPropertyInspector") {
                loadSettings(jsonObj.payload);
            } else if (jsonObj.event === "didReceiveSettings") {
                loadSettings(jsonObj.payload.settings);
            }
        };

        loadSettings(actionInfo.payload.settings);
    }

    function loadSettings(settings) {
        console.log("loading settings: " + JSON.stringify(settings));
        document.getElementById("adminURL").value = settings.adminURL
        document.getElementById("apiKey").value = settings.apiKey
        document.getElementById("disableDurationSeconds").value = settings.disableDurationSeconds
        document.getElementById("refreshIntervalSeconds").value = settings.refreshIntervalSeconds
    }

    function saveSettings() {
        if (websocket) {
            console.log("saving settings");
            websocket.send(JSON.stringify({
                "event": "setSettings",
                "context": uuid,
                "payload": {
                    "adminURL": document.getElementById("adminURL").value,
                    "apiKey": document.getElementById("apiKey").value,
                    "disableDurationSeconds": parseInt(document.getElementById("disableDurationSeconds").value),
                    "refreshIntervalSeconds": parseInt(document.getElementById("refreshIntervalSeconds").value),
                },
            }));
        }
    }
</script>
</body>
